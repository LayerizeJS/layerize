<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>services/crud.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Base.html">Base</a></li><li><a href="Crud.html">Crud</a><ul class='methods'><li data-type='method'><a href="Crud.html#_delete">_delete</a></li><li data-type='method'><a href="Crud.html#_get">_get</a></li><li data-type='method'><a href="Crud.html#_insert">_insert</a></li><li data-type='method'><a href="Crud.html#_search">_search</a></li><li data-type='method'><a href="Crud.html#_update">_update</a></li><li data-type='method'><a href="Crud.html#delete">delete</a></li><li data-type='method'><a href="Crud.html#get">get</a></li><li data-type='method'><a href="Crud.html#insert">insert</a></li><li data-type='method'><a href="Crud.html#search">search</a></li><li data-type='method'><a href="Crud.html#update">update</a></li></ul></li><li><a href="Export.html">Export</a></li><li><a href="JsonValidator.html">JsonValidator</a></li><li><a href="Layerize.html">Layerize</a><ul class='methods'><li data-type='method'><a href="Layerize.html#.Base">Base</a></li><li data-type='method'><a href="Layerize.html#.Crud">Crud</a></li><li data-type='method'><a href="Layerize.html#.Layers">Layers</a></li><li data-type='method'><a href="Layerize.html#.Schemas">Schemas</a></li><li data-type='method'><a href="Layerize.html#.Tables">Tables</a></li><li data-type='method'><a href="Layerize.html#_buildTables">_buildTables</a></li><li data-type='method'><a href="Layerize.html#_initiateCore">_initiateCore</a></li><li data-type='method'><a href="Layerize.html#initiate">initiate</a></li><li data-type='method'><a href="Layerize.html#install">install</a></li><li data-type='method'><a href="Layerize.html#layers">layers</a></li><li data-type='method'><a href="Layerize.html#loadControlledSchemas">loadControlledSchemas</a></li><li data-type='method'><a href="Layerize.html#loadSchemaListFromDB">loadSchemaListFromDB</a></li><li data-type='method'><a href="Layerize.html#uninstall">uninstall</a></li><li data-type='method'><a href="Layerize.html#updateAll">updateAll</a></li><li data-type='method'><a href="Layerize.html#validateSchemaVersions">validateSchemaVersions</a></li></ul></li><li><a href="Layers.html">Layers</a><ul class='methods'><li data-type='method'><a href="Layers.html#_applyFilters">_applyFilters</a></li><li data-type='method'><a href="Layers.html#_attachListToObject">_attachListToObject</a></li><li data-type='method'><a href="Layers.html#_attachToObject">_attachToObject</a></li><li data-type='method'><a href="Layers.html#_createTransaction">_createTransaction</a></li><li data-type='method'><a href="Layers.html#_dbFilter">_dbFilter</a></li><li data-type='method'><a href="Layers.html#_esFilter">_esFilter</a></li><li data-type='method'><a href="Layers.html#_includes">_includes</a></li><li data-type='method'><a href="Layers.html#_narrowedSchema">_narrowedSchema</a></li><li data-type='method'><a href="Layers.html#_stringToObjectFilters">_stringToObjectFilters</a></li><li data-type='method'><a href="Layers.html#_validate">_validate</a></li><li data-type='method'><a href="Layers.html#_validateFilter">_validateFilter</a></li><li data-type='method'><a href="Layers.html#clearAllTablesCache">clearAllTablesCache</a></li><li data-type='method'><a href="Layers.html#clearRecordCache">clearRecordCache</a></li><li data-type='method'><a href="Layers.html#clearTableCache">clearTableCache</a></li><li data-type='method'><a href="Layers.html#combine">combine</a></li><li data-type='method'><a href="Layers.html#commit">commit</a></li><li data-type='method'><a href="Layers.html#count">count</a></li><li data-type='method'><a href="Layers.html#delete">delete</a></li><li data-type='method'><a href="Layers.html#deleteByFilter">deleteByFilter</a></li><li data-type='method'><a href="Layers.html#deleteMany">deleteMany</a></li><li data-type='method'><a href="Layers.html#get">get</a></li><li data-type='method'><a href="Layers.html#getMany">getMany</a></li><li data-type='method'><a href="Layers.html#insert">insert</a></li><li data-type='method'><a href="Layers.html#insertMany">insertMany</a></li><li data-type='method'><a href="Layers.html#patch">patch</a></li><li data-type='method'><a href="Layers.html#patchByFilter">patchByFilter</a></li><li data-type='method'><a href="Layers.html#patchMany">patchMany</a></li><li data-type='method'><a href="Layers.html#rawCache">rawCache</a></li><li data-type='method'><a href="Layers.html#rawDatabase">rawDatabase</a></li><li data-type='method'><a href="Layers.html#rawSearch">rawSearch</a></li><li data-type='method'><a href="Layers.html#reindexSearch">reindexSearch</a></li><li data-type='method'><a href="Layers.html#rollback">rollback</a></li><li data-type='method'><a href="Layers.html#search">search</a></li><li data-type='method'><a href="Layers.html#transaction">transaction</a></li><li data-type='method'><a href="Layers.html#update">update</a></li><li data-type='method'><a href="Layers.html#updateMany">updateMany</a></li></ul></li><li><a href="SchemaBuilder.html">SchemaBuilder</a><ul class='methods'><li data-type='method'><a href="SchemaBuilder.html#layerize">layerize</a></li><li data-type='method'><a href="SchemaBuilder.html#load">load</a></li></ul></li><li><a href="Schemas.html">Schemas</a><ul class='methods'><li data-type='method'><a href="Schemas.html#_delete">_delete</a></li><li data-type='method'><a href="Schemas.html#_get">_get</a></li><li data-type='method'><a href="Schemas.html#_insert">_insert</a></li><li data-type='method'><a href="Schemas.html#_search">_search</a></li><li data-type='method'><a href="Schemas.html#_update">_update</a></li><li data-type='method'><a href="Schemas.html#delete">delete</a></li><li data-type='method'><a href="Schemas.html#get">get</a></li><li data-type='method'><a href="Schemas.html#insert">insert</a></li><li data-type='method'><a href="Schemas.html#search">search</a></li><li data-type='method'><a href="Schemas.html#update">update</a></li></ul></li><li><a href="Tables.html">Tables</a><ul class='methods'><li data-type='method'><a href="Tables.html#_delete">_delete</a></li><li data-type='method'><a href="Tables.html#_get">_get</a></li><li data-type='method'><a href="Tables.html#_insert">_insert</a></li><li data-type='method'><a href="Tables.html#_search">_search</a></li><li data-type='method'><a href="Tables.html#_update">_update</a></li><li data-type='method'><a href="Tables.html#delete">delete</a></li><li data-type='method'><a href="Tables.html#get">get</a></li><li data-type='method'><a href="Tables.html#insert">insert</a></li><li data-type='method'><a href="Tables.html#search">search</a></li><li data-type='method'><a href="Tables.html#update">update</a></li></ul></li></ul><h3><a href="global.html">Global</a></h3>
</nav>

<div id="main">
    
    <h1 class="page-title">services/crud.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>'use strict';
/* eslint-disable max-len, new-cap, camelcase*/

const Base = require('./base');
const Layers = require('./layers');

/**
 * The Crud class provides basic crud functionality utilizing the Layers. Designed for extending to use for table specific services.
 * @extends Base
 */
class Crud extends Base {

    /**
     * Create a Crud.
     * @param {object} config - available config
     */
    constructor (config = {}) {

        super(config);

    }

    /**
     * Deletes a single record
     * @param {string} key - primary key of the record
     * @returns {Promise&lt;success>} return a success object.
     */
    async delete (key = '') {

        this.debug('delete');

        let transaction = { rollback: async () => true };

        try {

            /**
             * create a transaction so we can lock the record we are wanting to delete
             * */
            transaction = this.layers.transaction();

            /**
             * lock record for deleting by passing the transaction to it
             * */
            await this._get(key, { transaction });

            /**
             * delete record
             * */
            await this._delete(key, { transaction });

            /**
             * apply changes and release record locks
             * */
            await transaction.commit();

            return { success: true };

        } catch (error) {

            /**
             * be sure to rollback if there is an error
             * */
            await transaction.rollback();

            throw this.error.handle({ error, caller: 'delete' });

        }

    }

    /**
     * Get a single record
     * @param {string} key - primary key of the record
     * @param {object} options - available options
     * @returns {Promise&lt;object>} return a record object.
     */
    async get (key, options = {}) {

        this.debug('get', options);
        try {

            return await this._get(key, options);

        } catch (error) {

            throw this.error.handle({ error, caller: 'get' });

        }

    }

    /**
     * Insert a single record
     * @param {object} data - primary key of the record
     * @param {object} options - available options
     * @returns {Promise&lt;object>} return a record object.
     */
    async insert (data = {}, options = {}) {

        this.debug('insert');

        try {

            let result = await this._insert(data, { returnRecord: true }, options);

            return result;

        } catch (error) {

            throw this.error.handle({ error, caller: 'insert' });

        }

    }

    /**
     * Search records within the table
     * @param {object} options - available options
     * @returns {Promise&lt;object>} return a record object.
     */
    async search (options = {}) {

        this.debug('search');
        try {

            let result = await this._search(options);

            return result;

        } catch (error) {

            throw this.error.handle({ error, caller: 'search' });

        }

    }

    /**
     * update records within the table
     * @param {string} key - primary key of the record
     * @param {object} data - record data needing updating
     * @param {object} options - available options
     * @returns {Promise&lt;object>} return a record object.
     */
    async update (key = '', data = {}, options = {}) {

        this.debug('update');

        let transaction = { rollback: async () => true };

        try {

            /**
             * create a transaction so we can lock the record we are wanting to update
             * */
            transaction = this.layers.transaction();

            /**
             * lock record for updating by passing the transaction to it
             * */
            await this._get(key, { transaction }, options);

            /**
             * update record
             * */
            await this._update(key, data, { transaction }, options);

            /**
             * apply changes and release record locks
             * */
            await transaction.commit();

            /**
             * grab updated record
             * */
            let result = await this._get(key, options);

            return result;

        } catch (error) {

            /**
             * be sure to rollback if there is an error
             */
            await transaction.rollback();

            throw this.error.handle({ error, caller: 'update' });

        }

    }

    /**
     * A protected internal method for deleting a records within the class's table
     * @access protected
     * @param {string} key - primary key of the record
     * @param {object} options - available options
     * @param {Layer} [options.transaction=null] - passes in a transaction layer to use, if null then it uses classes

     * @returns {Promise&lt;object>} return a record object.
     */
    async _delete (key = '', { transaction = null }) {

        this.debug('_delete');
        try {

            if (key === '') {

                throw new Error('a record key is required to update a record');

            }

            let options = arguments[1] || {};

            let layers = this.layers;

            if (transaction instanceof Layers) {

                layers = transaction;
                options.forUpdate = true;

            }

            ({ key, options, layers } = await this.__additionalValidation({ action: 'delete', key, options, layers }));

            let result = await layers.delete(this.table, key, options);

            return result;

        } catch (error) {

            throw this.error.handle({ error, caller: '_delete' });

        }

    }

    /**
     * A protected internal method for getting a records from the class's table
     * @access protected
     * @param {string} key - primary key of the record
     * @param {object} options - available options
     * @param {Layer} [options.transaction=null] - passes in a transaction layer to use, if null then it uses classes
     * @returns {Promise&lt;object>} return a record object.
     */
    async _get (key, { transaction = null } = {}) {

        this.debug('_get');

        try {

            let layers = this.layers;

            let options = arguments[1] || {};

            if (transaction instanceof Layers) {

                layers = transaction;
                options.forUpdate = true;

            }

            let result = await layers.get(this.table, key, options);

            return result;

        } catch (error) {

            throw this.error.handle({ error, caller: '_get' });

        }

    }

    /**
     * A protected internal method for inserting a single record into the class's table
     * @access protected
     * @param {object} data - data that is being inserted
     * @param {object} options - available options
     * @param {Layer} [options.transaction=null] - passes in a transaction layer to use, if null then it uses classes
     * @returns {Promise&lt;object>} return a record object.
     */
    async _insert (data = {}, { transaction = null, returnRecord = true, ignoreReadOnly = [] } = {}) {

        this.debug('_insert');

        try {

            let layers = this.layers;

            let options = arguments[1] || {};

            if (transaction instanceof Layers) {

                layers = transaction;
                options.forUpdate = true;

            }

            ({ data, options, layers, returnRecord } = await this.__additionalValidation({ action: 'insert', data, options, layers, returnRecord }));

            options.returnRecord = returnRecord;
            options.ignoreReadOnly = ignoreReadOnly;

            let result = await layers.insert(this.table, data, options);

            return result;

        } catch (error) {

            throw this.error.handle({ error, caller: '_insert' });

        }

    }

    /**
     * A protected internal method for searching records within the class's table
     * @access protected
     * @param {object} options - available options
     * @returns {Promise&lt;results>} return a results.
     */
    async _search (options = {}) {

        this.debug('_search');

        try {

            let result = await this.layers.search(this.table, options);

            return result;

        } catch (error) {

            throw this.error.handle({ error, caller: '_search' });

        }

    }

    /**
     * A protected internal method for updating records within the class's table
     * @access protected
     * @param {string} key - primary key of the record
     * @param {object} data - data that is being inserted
     * @param {object} options - available options
     * @param {Layer} [options.transaction=null] - passes in a transaction layer to use, if null then it uses classes
     * @returns {Promise&lt;object>} return a record object.
     */
    async _update (key = '', data = {}, { transaction = null, returnRecord = true, ignoreReadOnly = [] } = {}) {

        this.debug('_update');
        try {

            if (key === '') {

                throw new Error('a record key is required to update a record');

            }

            if (Object.keys(data).length === 0) {

                throw new Error('data object is empty and there is nothing to update');

            }

            let layers = this.layers;

            let options = arguments[2] || {};

            if (transaction instanceof Layers) {

                layers = transaction;
                options.forUpdate = true;

            }

            ({ key, data, options, layers, returnRecord } = await this.__additionalValidation({ action: 'update', key, data, options, layers, returnRecord }));

            options.returnRecord = returnRecord;
            options.ignoreReadOnly = ignoreReadOnly;

            let result = await layers.patch(this.table, key, data, options);

            return result;

        } catch (error) {

            throw this.error.handle({ error, caller: '_update' });

        }

    }

    /**
     * A private internal method for updating records within the class's table
     * @access private
     * @param {object} options - available options
     * @param {string} [options.action='insert'] - the type of action being done
     * @param {string} [options.key=''] - the primary key
     * @param {object} [options.data={}] - data
     * @param {object} [options.options={}] - options
     * @param {boolean} [options.returnRecords=false] - will return new record, if not a transaction
     * @param {Layer} [options.layers=null] - passes in a layer to use
     * @returns {Promise&lt;object>} return object.
     */
    async __additionalValidation ({ action = 'insert', key = '', data = {}, options = {}, returnRecord = true, layers = null } = {}) {

        this.debug('__additionalValidation', action);
        try {

            return { key, data, options, returnRecord, layers };

        } catch (error) {

            throw this.error.handle({ error, caller: '__additionalValidation' });

        }

    }

}

module.exports = Crud;
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Mon Dec 10 2018 13:53:47 GMT-0500 (EST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>


</body>
</html>
